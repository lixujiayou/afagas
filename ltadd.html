<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/font-awesome.min.css" rel="stylesheet" />
		<link href="css/userStyle.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/mui.picker.css" />
		<link rel="stylesheet" type="text/css" href="css/mui.poppicker.css" />
		<link href="../css/media_components.css" rel="stylesheet" />
		<link href="../css/imageviewer.css" rel="stylesheet" />
		<style>
			html,
		</style>

	</head>

	<body>
		<script src="../js/mui.js"></script>
		<script src="../js/mui.picker.js"></script>
		<script src="../js/mui.poppicker.js"></script>
		<script type="text/javascript" src="../js/md5.min.js"></script>
		<script src="../js/mui.previewimage.js"></script>
		<script type="text/javascript" src="../js/mui.zoom.js"></script>
		<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});
		</script>

		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">联通账单</h1>
		</header>
		<div class="mui-bar mui-bar-tab">
			<div class="tc user-btn-box">
				<div class="mui-row">
					<div class="mui-col-xs-6">
						<div class="pl20 pr10">
							<button id="btn_submit" class="btn btn-primary btn-block">提交</button>
						</div>
					</div>
					<div class="mui-col-xs-6">
						<div class="pr20 pl10">
							<button id="btn_cancle" class="btn btn-default btn-block">取消</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="mui-content">
			<div id="detail"></div>
			<div class="p20">
				<div class="user-con-box mb20">
					<div class="contitle">账单信息</div>
					<ul class="user-info-list">
						<li>
							<label><i class="uicon ui-3"></i><span class="vm">市公司：</span></label>

							<select id="city_id" class="data mui-btn-block">
								<option value="">--请选择市公司--</option>
								<option value="济南市">济南市</option>
								<option value="聊城市">聊城市</option>
								<option value="德州市">德州市</option>
								<option value="东营市">东营市</option>
								<option value="淄博市">淄博市</option>
								<option value="潍坊市">潍坊市</option>
								<option value="烟台市">烟台市</option>
								<option value="威海市">威海市</option>
								<option value="青岛市">青岛市</option>
								<option value="日照市">日照市</option>
								<option value="临沂市">临沂市</option>
								<option value="枣庄市">枣庄市</option>
								<option value="济宁市">济宁市</option>
								<option value="泰安市">泰安市</option>
								<option value="莱芜市">莱芜市</option>
								<option value="滨州市">滨州市</option>
								<option value="菏泽市">菏泽市</option>
							</select>
						</li>
						<li>
							<label><i class="uicon ui-8"></i><span class="vm">月份：</span></label>
							<div class="data">
								<input type="month" placeholder="点击输入" id="start_time" class="user-editpage-input" />
							</div>
						</li>

						<li>
							<label><i class="uicon ui-3"></i><span class="vm">是否完成账单签署确认：</span></label>
							<!--<div class="data">点击选择</div>-->

							<select id="select_bill" class="data user-normal-select">
								<option value=""> 点击选择</option>
								<option value="是">是</option>
								<option value="否">否</option>
							</select>
						</li>


						<li>
							<label><i class="uicon ui-4"></i><span class="vm">账单签署金额(万元；含税):</span></label>
							<input type="number" min="0.000000" step="0.000001" placeholder="自动计算(不可输入)" id="billAccount" style="font-size:14px ; width: 60%; "
							 disabled="disabled" />
						</li>

						<li>
							<label><i class="uicon ui-4"></i><span class="vm">塔类签署金额(万元；含税):</span></label>
							<input type="number" min="0.000000" step="0.000001" oninput="OnInput (event)" onpropertychange="OnPropChanged (event)"
							 placeholder="请输入" id="towerAccount" style="font-size:14px ; width: 60%;" />
						</li>
						<li>
							<label><i class="uicon ui-4"></i><span class="vm">室分签署金额(万元；含税):</span></label>
							<input type="number" min="0.000000" step="0.000001" oninput="OnInput (event)" onpropertychange="OnPropChanged (event)"
							 placeholder="请输入" id="roomAccount" style="font-size:14px ;width: 60%; " />
						</li>
						<li>
							<label><i class="uicon ui-4"></i><span class="vm">微站签署金额(万元；含税):</span></label>
							<input type="number" min="0.000000" step="0.000001" oninput="OnInput (event)" onpropertychange="OnPropChanged (event)"
							 placeholder="请输入" id="siteAccount" style="font-size:14px ;width: 60%; " />
						</li>
						<li>
							<label><i class="uicon ui-4"></i><span class="vm">其他业务签署金额(万元；含税):</span></label>
							<input type="number" min="0.000000" step="0.000001" oninput="OnInput (event)" onpropertychange="OnPropChanged (event)"
							 placeholder="请输入" id="otherAccount" style="font-size:14px ; width: 60%;" />
						</li>

						<li>
							<label><i class="uicon ui-3"></i><span class="vm">发票是否开具：</span></label>
							<!--<div class="data">点击选择</div>-->
							<select id="select_issue" class="data user-normal-select">
								<option value="">点击选择</option>
								<option value="是">是</option>
								<option value="否">否</option>
							</select>
						</li>
						<li>
							<label><i class="uicon ui-3"></i><span class="vm">发票是否递交：</span></label>
							<!--<div class="data">点击选择</div>-->
							<select id="select_issubmit" class="data user-normal-select">
								<option value="">点击选择</option>
								<option value="是">是</option>
								<option value="否">否</option>
							</select>
						</li>

						<li>
							<label><i class="uicon ui-3"></i><span class="vm">付款流程是否发起：</span></label>
							<!--<div class="data">点击选择</div>-->
							<select id="select_isprocess" class="data user-normal-select">
								<option value="">点击选择</option>
								<option value="是">是</option>
								<option value="否">否</option>
							</select>
						</li>

						<li style="display: none;">
							<label><i class="uicon ui-3"></i><span class="vm">报账单是否寄出：</span></label>
							<!--<div class="data">点击选择</div>-->
							<select id="select_issend" class="data user-normal-select">
								<option value="">点击选择</option>
								<option value="是">是</option>
								<option value="否">否</option>
							</select>
						</li>
						<li>
							<label><i class="uicon ui-3"></i><span class="vm">付款流程是否完毕:</span></label>
							<!--<div class="data">点击选择</div>-->
							<select id="select_isreach1" class="data user-normal-select">
								<option value="">点击选择</option>
								<option value="是">是</option>
								<option value="否">否</option>
							</select>
						</li>

						<li style="display: none;">
							<label><i class="uicon ui-3"></i><span class="vm">报账单是否到省移动:</span></label>
							<!--<div class="data">点击选择</div>-->
							<select id="select_isreach2" class="data user-normal-select">
								<option value="">点击选择</option>
								<option value="是">是</option>
								<option value="否">否</option>
							</select>
						</li>
						<li>
							<label><i class="uicon ui-4"></i><span class="vm">报账金额（万元；含税）:</span></label>
							<input type="number" min="0.000000" step="0.000001" placeholder="请输入" id="bzje" style="font-size:14px ;width: 60%; " />
						</li>

						<li>
							<label><i class="uicon ui-3"></i><span class="vm">服务费是否全额到账:</span></label>
							<!--<div class="data">点击选择</div>-->
							<select id="select_isarrive" class="data user-normal-select">
								<option value="">点击选择</option>
								<option value="是">是</option>
								<option value="否">否</option>
							</select>
						</li>

						<li>
							<label><i class="uicon ui-4"></i><span class="vm">服务费到账金额（万元；含税）:</span></label>
							<input type="number" min="0.000000" step="0.000001" placeholder="请输入" id="acceptLimit" style="font-size:14px ;width: 60%; " />
						</li>

						<li>
							<label><i class="uicon ui-4"></i><span class="vm">本月未确认金额（万元；含税）:</span></label>
							<input type="number" step="0.0000001" placeholder="请输入" id="unconfirmedje" style="font-size:14px ;width: 60%; " />
						</li>
						<li>
							<label><i class="uicon ui-4"></i><span class="vm">未确认原因:</span></label>
							<input type="text" placeholder="请输入" id="unconfirmedyy" style="font-size:14px ;width: 60%; " />
						</li>
						<li>
							<label><i class="uicon ui-4"></i><span class="vm">本月已确认未结算金额（万元；含税）:</span></label>
							<input type="number" step="0.0000001" placeholder="请输入" id="unsettledje" style="font-size:14px ;width: 60%; " />
						</li>
						<li>
							<label><i class="uicon ui-4"></i><span class="vm">已确认未结算原因:</span></label>
							<input type="text" placeholder="请输入" id="unsettledyy" style="font-size:14px ;width: 60%; " />
						</li>
						<li>
							<label><i class="uicon ui-4"></i><span class="vm">备注:</span></label>
							<input type="text" placeholder="请输入" id="remark" style="font-size:14px ;width: 60%; " />
						</li>
					</ul>
					<ul class="mui-table-view mui-grid-view" style="background: transparent; ">
						<li class="mui-table-view-cell mui-media ">
							<h5 class="mui-pull-right" style="background: #FB9A0C; width: 4px; height: 16px; "></h5>
						</li>
						<li class="mui-table-view-cell mui-media mui-col-xs-11">
							<h5 class="mui-pull-left" style="text-align: center;  ">图片信息</h5>
						</li>
						<li class="mui-table-view-cell mui-media mui-col-xs-4">
							<h5 class="mui-pull-left" style="text-align: center; color: black; font-size: 14px;">本次照片:</h5>
						</li>
						<li class="mui-table-view-cell mui-media mui-col-xs-8">
							<div id="imgList"></div>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</body>

</html>

<script type="text/javascript">
	function OnInput(event) {
		//    alert ("The new content: " + event.target.value);
		var a = towerAccount.value;
		var b = roomAccount.value;
		var c = otherAccount.value;
		var d = siteAccount.value;
		if (a == null || a.length < 1) {
			a = '0';
		}
		if (b == null || b.length < 1) {
			b = '0';
		}
		if (c == null || c.length < 1) {
			c = '0';
		}
		if (d == null || d.length < 1) {
			d = '0';
		}
		try {
			billAccount.value = (parseFloat(a) + parseFloat(b) + parseFloat(c) + parseFloat(d)).toFixed(6);
		} catch (e) {
			alert("输入的数值有误");
		}
	}
	(function($) {
		$.init();
		var attachmentId;
		var startTime;
		var select_bill, select_issue, select_issubmit, select_isprocess;
		var select_issend, select_isreach1, select_isreach2, select_isarrive;
		var billAccount, towerAccount, roomAccount, otherAccount, acceptLimit, siteAccount;
		var btn_submit;
		var btn_cancle;
		var city_id;
		var bzje;
		var remark;
		var numtest = 1;
		var liTake;
		var liPhoto;
		var bt_img_discern;
		var parseImgUrl;
		var imgAllMyList = new Array;
		var imgAllMyListTag = new Array;
		var myImageList = new Array;
		var base64List = new Array;
		var isFirst = true;

		var unconfirmedje, unconfirmedyy, unsettledje, unsettledyy;

		var mCurrentWebView;

		mui.plusReady(function() {
			startTime = document.getElementById("start_time");
			btn_submit = document.getElementById("btn_submit");
			btn_cancle = document.getElementById("btn_cancle");

			select_bill = document.getElementById("select_bill");
			select_issue = document.getElementById("select_issue");
			select_issubmit = document.getElementById("select_issubmit");
			select_isprocess = document.getElementById("select_isprocess");
			select_issend = document.getElementById("select_issend");
			select_isreach1 = document.getElementById("select_isreach1");
			select_isreach2 = document.getElementById("select_isreach2");
			select_isarrive = document.getElementById("select_isarrive");

			billAccount = document.getElementById("billAccount");
			towerAccount = document.getElementById("towerAccount");
			roomAccount = document.getElementById("roomAccount");
			otherAccount = document.getElementById("otherAccount");
			acceptLimit = document.getElementById("acceptLimit");
			bzje = document.getElementById("bzje");
			remark = document.getElementById("remark");

			city_id = document.getElementById("city_id");

			siteAccount = document.getElementById("siteAccount");

			unconfirmedje = document.getElementById("unconfirmedje");
			unconfirmedyy = document.getElementById("unconfirmedyy");
			unsettledje = document.getElementById("unsettledje");
			unsettledyy = document.getElementById("unsettledyy");
			mCurrentWebView = plus.webview.currentWebview();

			mui('#imgList').imageListInit({
				size: 5
			});

			btn_submit.addEventListener("tap", function() {
				getDateDiff();
			});

			btn_cancle.addEventListener("tap", function() {
				mui.back();
			});

			select_bill.addEventListener("change", function() {
				select_bill.value = select_bill.options[select_bill.selectedIndex].value;
			});
			select_issue.addEventListener("change", function() {
				select_issue.value = select_issue.options[select_issue.selectedIndex].value;
			});
			select_issubmit.addEventListener("change", function() {
				select_issubmit.value = select_issubmit.options[select_issubmit.selectedIndex].value;
			});
			select_isprocess.addEventListener("change", function() {
				select_isprocess.value = select_isprocess.options[select_isprocess.selectedIndex].value;
			});
			select_issend.addEventListener("change", function() {
				select_issend.value = select_issend.options[select_issend.selectedIndex].value;
			});
			select_isreach1.addEventListener("change", function() {
				select_isreach1.value = select_isreach1.options[select_isreach1.selectedIndex].value;
			});
			select_isreach2.addEventListener("change", function() {
				select_isreach2.value = select_isreach2.options[select_isreach2.selectedIndex].value;
			});
			select_isarrive.addEventListener("change", function() {
				select_isarrive.value = select_isarrive.options[select_isarrive.selectedIndex].value;
				if (select_isarrive.value == '是') {
					acceptLimit.value = billAccount.value;
					acceptLimit.disabled = "";
					acceptLimit.placeholder = "请输入";
				} else {
					acceptLimit.value = '';
					acceptLimit.disabled = "disabled";
					acceptLimit.placeholder = "不可输入";
				}
			});

			city_id.addEventListener("change", function() {
				city_id.value = city_id.options[city_id.selectedIndex].value;
			});
			if (plus.storage.getItem("city") != null && plus.storage.getItem("city").length > 0) {
				var citys = city_id.options;
				for (var m = 0; m < citys.length; m++) {
					var option0 = citys[m];
					if (option0.value == plus.storage.getItem("city")) {
						console.log(option0.value)
						option0.selected = true;
					} else {
						option0.selected = false;
					}
				}

				city_id.disabled = "disabled";
			}


		});

		//添加选中图片到回复区域--begin
		function addImg(path, isAgain) {
			plus.nativeUI.showWaiting("正在处理图片...");
			var hb_path = '_downloads/image/' + md5(path) + '.jpg'; //HBuilder平台路径
			var sd_path = plus.io.convertLocalFileSystemURL(hb_path); //SD卡绝对路径
			console.log("=====sd_path==" + sd_path);
			plus.zip.compressImage({
					src: path,
					dst: sd_path,
					quality: 20,
					format: "jpg",
					overwrite: true
				},
				function() {
					var Img = new Image();
					Img.src = sd_path;
					Img.onload = function() {
						console.log("2===================================");
						var myCanvas = document.createElement("canvas");
						myCanvas.width = plus.screen.resolutionWidth * plus.screen.scale;
						myCanvas.height = plus.screen.resolutionHeight * plus.screen.scale;
						var width = myCanvas.width;
						var height = myCanvas.height;
						var ctx = myCanvas.getContext("2d");
						ctx.drawImage(Img, 0, 0, width, height);
						ctx.font = "bold 30px microsoft yahei";
						ctx.fillStyle = "rgba(255,0,0,1)";


						console.log("3===================================");
						var data = myCanvas.toDataURL();
						//TODO  bitmap 修改图片 start
						var bitmap = new plus.nativeObj.Bitmap();
						bitmap.loadBase64Data(data, function() {
							//TODO  bitmap 修改图片 end
							bitmap.save(sd_path, {
								overwrite: true
							}, function(i) {
								var result = JSON.stringify(i);
								var resultData = JSON.parse(result);
								var target = resultData.target;
								console.log('保存图片成功：' + result);
								//start
								var itemPhotoPath = target.replace("file://", "");
								plus.nativeUI.closeWaiting();
								if (isAgain) {
									addImg(itemPhotoPath, false);
									return;
								}

								//document.getElementById("imgList2").src = itemPhotoPath;
								for (var i = 0; i < imgAllMyListTag.length; i++) {
									if (imgAllMyListTag[i] == "1") {
										imgAllMyList[i] = itemPhotoPath;
									}
								}
								console.log("加入图片列表的地址:" + itemPhotoPath);

								//			myImageList[myImageList.length] = itemPhotoPath;
								//			console.log(imgAllMyList.length + "新增=====" + myImageList.toString());
								changeImageToBase64();
								//end
								bitmap.clear();

								parseImgUrl = null;
							}, function(e) {
								plus.nativeUI.closeWaiting();
								console.log('保存图片失败：' + JSON.stringify(e));
							});

						}, function() {
							plus.nativeUI.closeWaiting();
							console.log("加载图片失败");
						});
					}
				},
				function(error) {
					plus.nativeUI.closeWaiting();
					alert("图片处理失败!");
				});
		}





		function RemoveValByIndex(arr, index) {
			arr.splice(index, 1);
		}


		// Internet Explorer
		function OnPropChanged(event) {
			if (event.propertyName.toLowerCase() == "value") {
				alert("The new content111: " + event.srcElement.value);
			}
		}

		/**
		 *获取字典 
		 */
		function gettypeList() {
			plus.nativeUI.showWaiting("正在初始化信息...");
			var table = document.body.querySelector('.user-normal-select');
			var url = plus.storage.getItem("url") + plus.storage.getItem("getDitcByType") + "?dictType=" + "leaveType";
			mui.ajax(url, {
				type: 'get',
				dataType: 'json',
				timeout: 10000 * 60,
				success: function(response) {
					plus.nativeUI.closeWaiting();
					var result = JSON.stringify(response);
					console.log("下拉返回的结果：" + result);
					var data = JSON.parse(result);
					//console.log("解析后返回的结果：" + data.length);

					if (data != null && data.length > 1) {
						var resultList = data;

						if (typeof(workList) == "undefined") {
							workList = resultList;
						} else {
							workList.length = 0;
							workList = resultList;
						}

						for (var i = 0; i < resultList.length; i++) {
							var dictId = resultList[i].dictId;
							var dictValue = resultList[i].dictValue;

							var option = document.createElement('option');
							//								div.className = 'mui-table-view mui-row';
							//								div.setAttribute("id", i);
							//								div.style.background = 'white';
							//								div.style.marginTop = '12px'; 
							option.innerHTML = dictValue;
							table.appendChild(option);
						}

					} else {
						mui.toast("初始化失败,请重试");
					}
				},
				error: function(xhr, type, errorThrown) {
					mui.alert(xhr.status);
					plus.nativeUI.closeWaiting();
					console.log("error:" + xhr.response);
					console.log("error:" + xhr.status);
				}
			});
		}

		/**
		 *提交 
		 */
		function submitInfo() {
			//field : 'isSign',title : "是否完成账单签署确认",
			//field : 'billPrice',title : "账单签署金额（万元;含税）",
			//field : 'towerPrice',title : "其中:塔类签署金额（万元;含税）",
			//field : 'roomPrice',title : "室分签署金额（万元;含税）",
			//field : 'otherPrice',itle : "塔类,室分之外的其他业务签署金额（万元;含税）",
			//field : 'isOpening',title : "发票是否开具",
			//field : 'isSubmit',title : "发票是否递交",
			//field : 'isProcessInitiation',title : "付款流程是否发起",
			//field : 'isMail',title : "报账单是否寄出",
			//field : 'isPeovinceFlow',title : "付款流程是否到省移动",
			//field : 'isPeovinceAccount',title : "报账单是否到省移动",
			//field : 'isFullService',title : "服务费是否全额到账",
			//field : 'amountPrice',title : "服务费到账金额",
			var monthId = startTime.value;
			if (monthId.indexOf("-") != -1) {
				monthId = monthId.replace("-", "");
			}

			plus.nativeUI.showWaiting("正在提交...");
			var url = plus.storage.getItem("url") + "trms/plugins/settlementDaily/tcheckdailyapp/createlt.ilf";
			console.log("monthId=" + monthId + "&isSign=" + select_bill.value + "&billPrice=" + billAccount.value +
				"&towerPrice=" + towerAccount.value + "&otherPrice=" + otherAccount.value);
			console.log("&isOpening=" + select_issue.value + "&isSubmit=" + select_issubmit.value + "&isProcessInitiation=" +
				select_isprocess.value + "&isMail=" + select_issend.value + "&isPeovinceFlow=" + select_isreach1.value);
			console.log("&isPeovinceAccount=" + select_isreach2.value + "&isFullService=" + acceptLimit.value + "&cityCompany=" +
				city_id.value);
			console.log("attachmentId====" + attachmentId);
			console.log("isProcessOver====" + select_isreach1.value);
			mui.ajax(url, {
				type: 'post',
				dataType: 'json',
				timeout: 10000 * 60,
				data: {
					userName: plus.storage.getItem("USER_NAME"),
					userId: plus.storage.getItem("USER_ID"),
					attachmentId: attachmentId,
					//				yys: plus.storage.getItem("YYS"),
					cityCompany: city_id.value,
					monthId: monthId,
					isSign: select_bill.value,
					billPrice: billAccount.value,
					towerPrice: towerAccount.value,
					roomPrice: roomAccount.value,
					wzPrice: siteAccount.value,
					otherPrice: otherAccount.value,
					isOpening: select_issue.value,
					isSubmit: select_issubmit.value,
					isProcessInitiation: select_isprocess.value,
					//				isMail: select_issend.value,
					isProcessOver: select_isreach1.value,
					//				isPeovinceAccount: select_isreach2.value,
					isFullService: select_isarrive.value,
					amountPrice: acceptLimit.value,
					bzje: bzje.value,
					remark: remark.value,
					bywqrPrice: unconfirmedje.value,
					wqryy: unconfirmedyy.value,
					byyqrwjsPrice: unsettledje.value,
					yqrwjsyy: unsettledyy.value

				},
				success: function(response) {
					plus.nativeUI.closeWaiting();
					var result = JSON.stringify(response);
					console.log("返回的结果：" + result);
					var data = JSON.parse(result);

					if (true == data.success) {
						mui.alert("提交成功!");
						var detailPage1 = plus.webview.getWebviewById('ltList.html');
						mui.fire(detailPage1, "ltList", "");
						mCurrentWebView.close();

					} else {
						mui.alert(data.message);
					}
				},
				error: function(xhr, type, errorThrown) {
					mui.alert(xhr.status);
					plus.nativeUI.closeWaiting();
					console.log("登录的error:" + xhr.response);
					console.log("登录的error:" + xhr.status);
				}
			});
		}

		function getDateDiff() {

			var date1 = startTime.value;
			var billValue = select_bill.value;
			var issueValue = select_issue.value;
			var issubmitValue = select_issubmit.value;
			var isprocessValue = select_isprocess.value;
			var issendValue = select_issend.value;
			var isreach1Value = select_isreach1.value;
			var isreach2Value = select_isreach2.value;
			var isarriveValue = select_isarrive.value;
			var billAccountValue = billAccount.value;
			var towerAccountValue = towerAccount.value;
			var roomAccountValue = roomAccount.value;
			var otherAccountValue = otherAccount.value;
			var acceptLimitValue = acceptLimit.value;
			if (city_id.value == null || city_id.length < 1) {
				mui.toast("请选择市公司");
				return;
			}
			if (date1 == null || date1.length < 1) {
				mui.toast("请选择月份");
				return;
			}
			if (billValue == null || billValue.length < 1) {
				mui.toast("请选择是否完成账单签署确认");
				return;
			} else {
				if (billValue == '是') {
					if (towerAccountValue == null || towerAccountValue.length < 1) {
						mui.toast("请输入塔类签署金额");
						return;
					}
					if (roomAccountValue == null || roomAccountValue.length < 1) {
						mui.toast("请输入室分签署金额");
						return;
					}
					if (otherAccountValue == null || otherAccountValue.length < 1) {
						mui.toast("请输入塔类，室分之外的其他业务签署金额");
						return;
					}
				}

			}
			/*if(issueValue == null || issueValue.length < 1) {
				mui.toast("请选择发票是否开具");
				return;
		}
		if(issubmitValue == null || issubmitValue.length < 1) {
				mui.toast("请选择发票是否提交");
				return;
		}
		if(isprocessValue == null || isprocessValue.length < 1) {
				mui.toast("请选择付款流程是否发起");
				return;
		}
//		if(issendValue == null || issendValue.length < 1) {
//				mui.toast("请选择报账单是否寄出");
//				return;
//		}
		 if( isreach1Value == null || isreach1Value.length < 1) {
				mui.toast("请选择付款流程是否完毕");
				return;
		}
//		if(isreach2Value == null || isreach2Value.length < 1) {
//				mui.toast("请选择报账单是否到省移动");
//				return;
//		}
		if(isarriveValue == null || isarriveValue.length < 1) {
				mui.toast("请选择服务费是否全额到帐");
				return;
		}
*/
			console.log("length=====" + imgAllMyList.length);
			if (imgAllMyList.length > 0) {
				var photopath1 = imgAllMyList[0];
				uploadData(photopath1, 0);
			} else {
				submitInfo();
			}

		}



		function getBase64(path) {
			plus.nativeUI.showWaiting("正在处理图片...");
			//本地缓存路径
			var hb_path = '_downloads/image/' + md5(path) + '.jpg'; //HBuilder平台路径
			var sd_path = plus.io.convertLocalFileSystemURL(hb_path); //SD卡绝对路径
			console.log("=====sd_path==" + sd_path);

			plus.zip.compressImage({
					src: path,
					dst: sd_path,
					quality: 40,
					format: "jpg",
					overwrite: true
				},
				function() {
					var Img = new Image();
					Img.src = sd_path;
					Img.onload = function() {
						console.log("2===================================");
						var myCanvas = document.createElement("canvas");
						myCanvas.width = plus.screen.resolutionWidth * plus.screen.scale;
						myCanvas.height = plus.screen.resolutionHeight * plus.screen.scale;
						var width = myCanvas.width;
						var height = myCanvas.height;
						var ctx = myCanvas.getContext("2d");
						ctx.drawImage(Img, 0, 0, width, height);
						console.log("3===================================");
						var data = myCanvas.toDataURL();
						console.log("4===================================");
						var bitmap = new plus.nativeObj.Bitmap();
						bitmap.loadBase64Data(data, function() {
							//TODO  bitmap 修改图片 end
							bitmap.save(sd_path, {
								overwrite: true
							}, function(i) {
								var result = JSON.stringify(i);
								var resultData = JSON.parse(result);
								var target = resultData.target;
								//console.log('保存图片成功：' + result);
								//start
								var itemPhotoPath = target.replace("file://", "");
								var imageDiv = document.createElement("div");
								imageDiv.className = "media-item image-item mui-col-"
								imageDiv.setAttribute("id", target);
								imageDiv.innerHTML = '' +
									'<img class="file mui-action-preview" data-preview-src="' + data + '" data-preview-group="1" src="' +
									data + '" addTime="' + (new Date()).getTime() + '" />' +
									'<span class="mui-icon mui-icon-closeempty"></span>';
								imageList.appendChild(imageDiv);

								console.log("加入图片列表的地址:" + itemPhotoPath);
								myImageList[myImageList.length] = itemPhotoPath;
								console.log(imgAllMyList.length + "新增=====" + myImageList.toString());

								//end
								bitmap.clear();
								plus.nativeUI.closeWaiting();
								parseImgUrl = null;
							}, function(e) {
								plus.nativeUI.closeWaiting();
								console.log('保存图片失败：' + JSON.stringify(e));
							});

						}, function() {
							plus.nativeUI.closeWaiting();
							console.log("加载图片失败");
						});
					}
				},
				function(error) {
					plus.nativeUI.closeWaiting();
					alert("图片处理失败!");
				});
		}

		function changeImageToBase64() {
			plus.nativeUI.showWaiting("正在处理图片...");
			if (base64List == null || base64List.length == 0) {
				plus.io.requestFileSystem(plus.io.PRIVATE_WWW,
					function(fs) {
						for (var iii = 0; iii < myImageList.length; iii++) {
							var imageUrlTest = myImageList[iii];
							var rootEntry = fs.root;
							var reader = null;
							rootEntry.getFile(imageUrlTest, {},
								function(entry) {
									entry.file(function(file) {
											reader = new plus.io.FileReader();
											reader.onloadend = function(e) {
												console.log("Read success");
												base64List[base64List.length] = e.target.result;
												//console.log(base64List.length + "===000000===" + myImageList.length);
												if (base64List.length == myImageList.length) {
													plus.nativeUI.closeWaiting();
													submitInfo();
												}
											};
											reader.readAsDataURL(file);
										},
										function(e) {
											if (iii == myImageList.length) {
												plus.nativeUI.closeWaiting();
											}
											mui.alert(e.message);
										});
								});
						}
					});
			} else {
				submitInfo();
			}
		}





		/**
		 * 上传图片
		 */
		function uploadData(photoPath, len) {
			plus.nativeUI.showWaiting("正在上传");
			//var url = plus.storage.getItem("url") + "/costAudit/mobile/reouceCheck/mobileCheckInIos.do";
			var url = plus.storage.getItem("url") + "trms/plugins/settlementDaily/tcheckdailyapp/attachuploadAPP1.ilf";
			if (0 != photoPath.toString().indexOf("file://")) {
				photoPath = "file://" + photoPath;
			}

			console.log("上传文件的路径:" + photoPath);
			var task = plus.uploader.createUpload(url, {
				method: 'POST'
			}, function(t, status) {
				if (status == 200) {
					plus.nativeUI.closeWaiting();
					var resultss = JSON.parse(t.responseText);
					if (len == 0) {
						attachmentId = resultss.attachmentId;
					}
					console.log("*************attachmentId===" + attachmentId);
					console.log("*************上传图片成功");
					//上传成功 删除图片
					if (len == imgAllMyList.length - 1) {
						submitInfo();
					} else {
						var photopath2 = imgAllMyList[len + 1];
						uploadData(photopath2, len + 1);
					}
				} else {
					plus.nativeUI.closeWaiting();
					mui.alert("图片上传失败");
					console.log("图片的返回:" + status);
					task.abort();
				}
			});
			task.addData("userName", plus.storage.getItem("USER_NAME"));
			task.addData("serialNumber", attachmentId);
			task.addFile(photoPath, {
				key: 'file'
			});
			task.start();
		}

		/*
		 *上传图片列表
		 */
		function uploadImgList(imgBase64, filename) {
			var url = plus.storage.getItem("url") + "trms/plugins/settlementDaily/tcheckdailyapp/attachuploadAPP.ilf";
			console.log(url + "?imgBase64=" + imgBase64 + "&serialNumber=" + attachmentId + "&userName=" + plus.storage.getItem(
				"USER_NAME"));
			mui.ajax(url, {
				type: 'post',
				dataType: 'json',
				timeout: 10000 * 60,
				data: {
					imgBase64: imgBase64,
					serialNumber: attachmentId,
					Pname: filename,
					userName: plus.storage.getItem("USER_NAME")

				},
				success: function(response) {
					var result = JSON.stringify(response);
					console.log("下载图片列表的返回:" + result);
					var data = JSON.parse(result);
					if (true == data.result) {} else {}
				},
				error: function(xhr, type, errorThrown) {
					console.log("获取列表的error:" + xhr.response);
					console.log("获取列表的error:" + xhr.status);
				}

			});
		}




		/**
		 * 图片列表
		 */
		$.fn.imageListInit = function(options) {
			var imageListAll = this;

			if (imageListAll.length > 0) {
				imageListAll.each(function(e) {
					var imageList = this;
					imageList.className = "custom-media-list custom-image-list mui-row";
					imageList.options = $.extend($.ImageListOptionsDefaults, options);
					if (imageList.options.size == 1) {
						imageList.options.multiple = false
					} else if (imageList.options.size > 1) {
						imageList.options.multiple = true;
					} else {
						mui.toast("参数错误！");
					}
					myImageList.length = 0;
					for (var i = 0; i < imgAllMyListTag.length; i++) {
						addImg(imgAllMyList[i], false);

					}

					var addButtonHtml =
						'<button class="mui-icon mui-icon-image media-item button-item mui-col-"><h6>拍照</h6></button>'
					imageList.innerHTML = addButtonHtml;
					imageList.addButton = imageList.querySelector(".button-item");
					imageList.addButton.addEventListener("tap", function() {
						var nowImageLength = imageList.querySelectorAll("img.file").length; //已经有的图片张数
						if (!checkImgNum(0, nowImageLength)) {
							return;
						}
						var btnArray = [{
							title: "拍照"
						}, {
							title: "从相册选择"
						}];
						plus.nativeUI.actionSheet({
							title: "选择照片",
							cancel: "取消",
							buttons: btnArray
						}, function(e) {
							var index = e.index;
							switch (index) {
								case 0:
									break;
								case 1:
									var cmr = plus.camera.getCamera();
									cmr.captureImage(function(path) {
										//										imgAllMyList.push(path);
										//										imgAllMyListTag.push("0");
										addImg(path, true);
									}, function(err) {});
									break;
								case 2:
									plus.gallery.pick(function(e) {
										if (imageList.options.multiple) {
											if (!checkImgNum(e.files.length, nowImageLength)) {
												return false;
											}
											for (var i in e.files) {
												plus.io.resolveLocalFileSystemURL(e.files[i], function(entry) {
													var localURL = entry.toLocalURL();
													//													imgAllMyList.push(localURL);
													//													imgAllMyListTag.push("0");
													addImg(localURL, true); //处理图片的地方
												}, function(e) {
													console.log("失败：" + error.message);
												}, {
													filename: "_doc/camera/",
													index: 1
												});
											}
										} else {
											plus.io.resolveLocalFileSystemURL(e, function(entry) {
												var localURL = entry.toLocalURL();
												//												imgAllMyList.push(localURL);
												//												imgAllMyListTag.push("0");
												addImg(localURL, true); //处理图片的地方
											}, function(e) {
												console.log("失败：" + error.message);
											}, {
												filename: "_doc/camera/",
												index: 1
											});
										}
									}, function(e) {
										mui.toast("取消选择图片");
									}, {
										filter: "image",
										multiple: imageList.options.multiple,
										maximum: imageList.options.size - nowImageLength
									});
									break;
							}
						});
					}, false);
					/**
					 * @param {Object} p 此次添加的个数
					 */
					function checkImgNum(p, i) {
						var all = i + p;
						if ((p > 0 && all > imageList.options.size) || (p == 0 && all >= imageList.options.size)) {
							mui.toast("图片不能超过" + imageList.options.size + "张");
							return false;
						} else {
							return true;
						}
					}

					//添加选中图片到回复区域--begin
					function addImg(path, isReadNum) {
						plus.nativeUI.showWaiting("正在处理图片...");
						//console.log("=====过来了==");
						//本地缓存路径
						var hb_path = '_downloads/image/' + md5(path) + '.jpg'; //HBuilder平台路径
						var sd_path = plus.io.convertLocalFileSystemURL(hb_path); //SD卡绝对路径
						console.log("=====sd_path==" + sd_path);
						plus.zip.compressImage({
								src: path,
								dst: sd_path,
								quality: 20,
								format: "jpg",
								overwrite: true
							},
							function() {
								var Img = new Image();
								Img.src = sd_path;
								Img.onload = function() {
									console.log("2===================================");
									var myCanvas = document.createElement("canvas");
									myCanvas.width = plus.screen.resolutionWidth * plus.screen.scale;
									myCanvas.height = plus.screen.resolutionHeight * plus.screen.scale;
									var width = myCanvas.width;
									var height = myCanvas.height;
									var ctx = myCanvas.getContext("2d");
									ctx.drawImage(Img, 0, 0, width, height);
									ctx.font = "bold 30px microsoft yahei";
									ctx.fillStyle = "rgba(255,0,0,1)";
									//									ctx.fillText("站点:" + cSiteName, 0, height - 300);
									//									ctx.fillText("拍照人:" + plus.storage.getItem("userName"), 0, height - 250, width - 10);
									//									ctx.fillText("经纬度:" + plus.storage.getItem("lng") + "," + plus.storage.getItem("lat"), 0, height - 200, width - 10);
									//									ctx.fillText("地址:" + plus.storage.getItem("cadress"), 0, height - 150, width - 10);
									//									ctx.fillText("拍照时间:" + getNowFormatDate(), 0, height - 100, width - 10);
									//									
									//									if(isReadNum) {
									//										ctx.fillText("读数:" + currentReadNum, 0, height - 50, width - 10);
									//									}
									console.log("3===================================");
									var data = myCanvas.toDataURL();
									//TODO  bitmap 修改图片 start
									var bitmap = new plus.nativeObj.Bitmap();
									bitmap.loadBase64Data(data, function() {
										//TODO  bitmap 修改图片 end
										bitmap.save(sd_path, {
											overwrite: true
										}, function(i) {
											var result = JSON.stringify(i);
											var resultData = JSON.parse(result);
											var target = resultData.target;
											//console.log('保存图片成功：' + result);
											//start
											var itemPhotoPath = target.replace("file://", "");
											var imageDiv = document.createElement("div");
											imageDiv.className = "media-item image-item mui-col-"
											imageDiv.setAttribute("id", itemPhotoPath);
											imageDiv.innerHTML = '' +
												'<img class="file mui-action-preview" data-preview-src="' + data +
												'" data-preview-group="1" src="' + data + '" addTime="' + (new Date()).getTime() + '" />' +
												'<span class="mui-icon mui-icon-closeempty"></span>';
											imageList.appendChild(imageDiv);

											console.log("加入图片列表的地址:" + itemPhotoPath);
											myImageList[myImageList.length] = itemPhotoPath;
											console.log(imgAllMyList.length + "新增=====" + myImageList.toString());
											if (isReadNum) {
												imgAllMyList.push(itemPhotoPath);
												imgAllMyListTag.push("0");
											}
											//end
											bitmap.clear();
											plus.nativeUI.closeWaiting();
											parseImgUrl = null;
										}, function(e) {
											plus.nativeUI.closeWaiting();
											console.log('保存图片失败：' + JSON.stringify(e));
										});

									}, function() {
										plus.nativeUI.closeWaiting();
										console.log("加载图片失败");
									});
								}
							},
							function(error) {
								plus.nativeUI.closeWaiting();
								alert("图片处理失败!");
							});
					}
				})

				imageListAll.on("tap", ".media-item.image-item", function(e) {
					var $this = this;
					if (e.target.className.match(new RegExp('(\\s|^)mui-icon-closeempty(\\s|$)'))) {
						numtest += 1;
						if (numtest == 2) {
							console.log("=====删除=====" + numtest);

							var $parentNode = $this.parentNode;
							var btnArray = ['是', '否'];
							mui.confirm('确定删除？', '删除', btnArray, function(e2) {
								numtest = 1;
								if (e2.index == 0) {
									$parentNode.removeChild($this);
									if (imgAllMyList.length > 0) {
										console.log("$this.getAttribut===" + $this.getAttribute("id"));
										for (var h = 0; h < imgAllMyList.length; h++) {
											if (imgAllMyList[h] == $this.getAttribute("id")) {
												RemoveValByIndex(imgAllMyListTag, h);
												RemoveValByIndex(imgAllMyList, h);
											}
										}

									}

								}
								//								RemoveValByIndex(imgAllMyList, e2.index);
								//								RemoveValByIndex(imgAllMyListTag, e2.index);
							})
						}
					}
				})
				if (!mui.getPreviewImage()) {
					mui.previewImage();
				}
			}
		}

	})(mui);
</script>