<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/font-awesome.min.css" rel="stylesheet" />
		<link href="css/userStyle.css" rel="stylesheet" />
		<link href="css/imageviewer.css" rel="stylesheet" />
		<link href="css/media_components.css" rel="stylesheet" />
		<link href="css/mui.picker.css" rel="stylesheet" />
		<link href="css/mui.picker.min.css" rel="stylesheet" />
		<style>
			.mui-btn {
				font-size: 16px;
				padding: 8px;
				margin: 3px;
			}
			
			h5.mui-content-padded {
				margin-left: 3px;
				margin-top: 20px !important;
			}
			
			h5.mui-content-padded:first-child {
				margin-top: 12px !important;
			}
			
			.ui-alert {
				text-align: center;
				padding: 20px 10px;
				font-size: 16px;
				color: #9ea4af;
			}
			
			.jyapply_li_lable {
				line-height: 30px;
				font-size: 13px;
				font-weight: normal;
				display: inline-block;
				margin-left: 28px;
				color: #9ea4af;
			}
			
			.jyapply_li_input {
				font-size: 14px;
				width: 50%;
				height: 30px;
				margin-left: 10px;
				-webkit-user-select: auto;
				color: #9ea4af;
			}
			
			.jyapply_li_a {
				color: #9ea4af;
				font-size: 14px;
				width: 50%;
				height: 30px;
				margin-left: 30px;
				text-align: center;
				line-height: 30px;
				border: #103E5C;
				border: 1px solid #999999;
				padding: 3px 8px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">任务审批</h1>
		</header>
		<div class="mui-bar mui-bar-tab">
			<div class="tc user-btn-box">
				<div class="mui-row">

					<div class="mui-col-xs-12">
						<div class="pl20 pr10">
							<button id="btn_submit" class="btn btn-primary btn-block">提交审核</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="mui-content">

			<div class="p20">

				<div class="user-con-box mb20">

					<ul class="user-info-list">
						<div class="contitle">审核任务信息</div>
						<li>
							<label><i class="uicon ui-8"></i><span class="vm">油卡编号(副卡)：</span></label>
							<div class="data">
								<input id="et_ykbh" type="text" class="user-editpage-input" readonly="readonly">
							</div>
						</li>
						<li>
							<label><i class="uicon ui-9"></i><span class="vm">类型：</span></label>
							<div class="data">
								<input type="text" id="et_leixing" class="user-editpage-input" readonly="readonly" />
							</div>
						</li>
						<li>
							<label><i class="uicon ui-3"></i><span class="vm">预估加油量(L)：</span></label>
							<div class="data">
								<input type="text" id="et_ygjyl" class="user-editpage-input" readonly="readonly" />
							</div>
						</li>
						<li>
							<label><i class="uicon ui-4"></i><span class="vm">预估加油金额(元)：</span></label>
							<div class="data">
								<input type="text" id="et_ygjyje" class="user-editpage-input" readonly="readonly" />
							</div>
						</li>
						<li>
							<label><i class="uicon ui-10"></i><span class="vm">加油原因：</span></label>
							<div class="data">
								<input type="text" id="et_yuanyin" class="user-editpage-input" readonly="readonly" />
							</div>
						</li>
						<li>
							<label><i class="uicon ui-12"></i><span class="vm">所属地市：</span></label>
							<div class="data">
								<input type="text" id="et_dishi" class="user-editpage-input" readonly="readonly">
							</div>
						</li>
						<li>
							<label><i class="uicon ui-16"></i><span class="vm">所属区县：</span></label>
							<div class="data">
								<input type="text" id="et_quxian" class="user-editpage-input" readonly="readonly">
							</div>
						</li>
						<li>
							<label><i class="uicon ui-14"></i><span class="vm">所属部门：</span></label>
							<div class="data">
								<input type="text" id="et_daiweigongsi" class="user-editpage-input" readonly="readonly">
							</div>
						</li>
						<li>
							<label><i class="uicon ui-15"></i><span class="vm">申请人：</span></label>
							<div class="data">
								<input type="text" id="et_shenqingren" class="user-editpage-input" readonly="readonly">
							</div>
						</li>
						<li>
							<label><i class="uicon ui-16"></i><span class="vm">申请时间：</span></label>
							<div class="data">
								<input type="text" id="et_sq_time" readonly="readonly" class="user-editpage-input" />
							</div>
						</li>

					</ul>

				</div>

				<div class="user-con-box mb20">
					<ul class="user-info-list">
						<div class="contitle">审核结果填写</div>

						<li>
							<b class="jyapply_li_lable">审核意见:</b>
							<a id="select_is_re" class="jyapply_li_a">请选择</a>
						</li>

						<li id="li_no">
							<div class="font-dark"><i class="uicon ui-11"></i><span class="vm">未通过原因：</span></div>

							<div class="font-gary pt10">
								<textarea rows="5" id="ps_mark" placeholder="请在此填写未通过原因或者录入未通过语音原因" class="f14"></textarea>
							</div>
							<div id="audioList"></div>
						</li>
					</ul>
				</div>

			</div>
		</div>
	</body>
	<script src="js/mui.min.js"></script>

	<script src="js/md5.min.js"></script>
	<script src="js/mui.zoom.js"></script>
	<script src="js/base64.jss"></script>
	<script src="js/mui.picker.min.js"></script>
	<script>
		var audioPath = "";
		var soundTime = ""; //录音时长
		var selectIsRe;
		var li_no;
		var btn_submit;
		var myOb;
		var ps_mark;
		var workId;
		var workFlowId;

		var et_ykbh; //油卡编号
		var et_leixing; //类型
		var et_ygjyl; //预估加油量
		var et_ygjyje; //预估加油金额
		var et_yuanyin; //加油原因
		var et_dishi; //所属地市
		var et_quxian; //所属区县
		var et_daiweigongsi; //代维公司
		var et_shenqingren; //申请人
		var et_sq_time; //申请时间
		(function($) {
			$.init();
			mui.init({
				swipeBack: true, //启用右滑关闭功能
				gestureConfig: {
					longtap: true, //默认为false
					hold: true, //默认为false，不监听
					release: true //默认为false，不监听
				}
			});
			mui.plusReady(function() {
				li_no = document.getElementById("li_no");
				selectIsRe = document.getElementById("select_is_re");
				ps_mark = document.getElementById("ps_mark");
				et_leixing = document.getElementById("et_leixing");
				et_ykbh = document.getElementById("et_ykbh");
				et_ygjyl = document.getElementById("et_ygjyl");
				et_ygjyje = document.getElementById("et_ygjyje");
				et_yuanyin = document.getElementById("et_yuanyin");
				et_dishi = document.getElementById("et_dishi");
				et_quxian = document.getElementById("et_quxian");
				et_daiweigongsi = document.getElementById("et_daiweigongsi");
				et_shenqingren = document.getElementById("et_shenqingren");
				et_sq_time = document.getElementById("et_sq_time");

				var userPicker = new $.PopPicker();
				userPicker.setData([{
					value: '通过',
					text: '通过'
				}, {
					value: '不通过',
					text: '不通过'
				}]);
				selectIsRe.addEventListener("click", function() {

					userPicker.show(function(items) {
						selectIsRe.innerText = items[0].value;
						if(items[0].value == "通过") {
							li_no.style.display = "none";
						} else {
							li_no.style.display = "block";
						}
					});

				}, false);

				workFlowId = plus.storage.getItem("s_f_id");
				workId = plus.storage.getItem("s_id");

				btn_submit = document.getElementById("btn_submit");
				btn_submit.addEventListener("click", function() {
					submitMyData();
				});
				initAudioMy();
				mui('#audioList').audioListInit({
					size: 1
				});
				getDataInfo();
			});

			function getDataInfo() {
				plus.nativeUI.showWaiting("正在初始化...");
				var url = plus.storage.getItem("url") + plus.storage.getItem("findByFlowId_jiayou_sq");
				console.log("===" + url + "?flowId=" + plus.storage.getItem("s_flowid"));
				mui.ajax(url, {
					type: 'post',
					dataType: 'json',
					timeout: 10000 * 60,
					data: {
						flowId: plus.storage.getItem("s_flowid"), //"1545891194004" //plus.storage.getItem("s_flowid"),
					},
					success: function(response) {
						plus.nativeUI.closeWaiting();
						var result = JSON.stringify(response);
						var data = JSON.parse(result);
						infoOb = data;
						console.log("===返回数据===" + result);
						if(data != null) {
							et_ykbh.value = data.fuelcardNo;
							et_leixing.value = data.fuelType;
							et_ygjyl.value = data.preEstimateFuelvolume + "";
							et_ygjyje.value = data.preEstimateFuelmoney + "";
							et_yuanyin.value = data.fuelReason;
							et_dishi.value = data.belongDs;
							et_quxian.value = data.belongQx;
							et_daiweigongsi.value = data.belongDaiweiCompany;
							et_shenqingren.value = data.applicant;
							et_sq_time.value = data.applicantTime;

						} else {
							mui.alert("系统未返回数据");
						}
					},
					error: function(xhr, type, errorThrown) {
						mui.alert(xhr.status);
						plus.nativeUI.closeWaiting();
						console.log("error:" + xhr.response);
						console.log("error:" + xhr.status);
					}
				});
			}

			// 扩展API加载完毕后调用onPlusReady回调函数 
			document.addEventListener("plusready", onPlusReady, false);
			var r = null;
			// 扩展API加载完毕，现在可以正常调用扩展API 
			function onPlusReady() {}
			// 创建上传任务
			function createUpload() {
				plus.nativeUI.showWaiting();
				var url = plus.storage.getItem("url") + "/reouceCheck/infoConfirm.do?userId=" + plus.storage.getItem("userid");

				console.log("audioPath=" + audioPath);

				var mRemark = document.getElementById("input_1").value;
				var mXian = sp1.value; //现场字段是否符合要求
				var mZhao = sp2.value; //照片是否符合要求
				var mShen = sp3.value; //审核意见
				var task = plus.uploader.createUpload(url, {}, function(t, status) {
					// 上传完成
					if(status == 200) {
						mui.alert("提交完成");
						plus.nativeUI.closeWaiting();
						closeOtherWindow();
					} else {
						plus.nativeUI.closeWaiting();
						mui.alert("提交失败" + status);
						task.abort();
					}
				});
				if("" != audioPath) {
					var path = plus.io.convertLocalFileSystemURL(audioPath);
					console.log("录音的本地路径:" + plus.io.convertLocalFileSystemURL(audioPath));
					if(0 != path.toString().indexOf("file://")) {
						path = "file://" + path;
					}
					task.addFile(path, {
						key: "fileData"
					});
				}

				task.addData("phySiteNo", plus.storage.getItem("siteNo"));
				task.addData("id", plus.storage.getItem("siteId"));
				task.addData("userRole", plus.storage.getItem("siteUserRole"));
				task.addData("mTime", soundTime + "");
				task.addData("remarks", mRemark);
				task.addData("colunm_is_trure", mXian);
				task.addData("photo_is_true", mZhao);
				task.addData("check_pass", mShen);
				task.addData("userId", plus.storage.getItem("userid"));
				console.log("上传语音等==mTime:" + soundTime);
				console.log("上传语音等==audioPath:" + audioPath);
				task.start();
			}

			// 监听上传任务状态
			function onStateChanged(upload, status) {
				if(upload.state == 4 && status == 200) {
					// 获取上传请求响应头数据
					console.log(upload.getAllResponseHeaders());
					// 上传完成
					plus.nativeUI.closeWaiting();
					console.log("Upload success: " + upload.responseText);
				}
			}

			function submitMyData() {
				if(selectIsRe.innerText == "请选择") {
					mui.toast("请选择审核意见");
					return;
				}

				plus.nativeUI.showWaiting("正在提交...");

				var url = plus.storage.getItem("url") + plus.storage.getItem("approval_jiayou");
				console.log("===" + plus.storage.getItem("username"));
				console.log("===" + workId);
				console.log("===" + workFlowId);
				mui.ajax(url, {
					type: 'post',
					dataType: 'json',
					timeout: 10000 * 60,
					data: {
						ownerName: plus.storage.getItem("username"),
						checkStatus: selectIsRe.innerText,
						intId: workId,
						flowId: workFlowId,
						checkSuggestion: ps_mark.value,
						userName: plus.storage.getItem("userRealname")
					},
					success: function(response) {
						plus.nativeUI.closeWaiting();
						var result = JSON.stringify(response);
						console.log("全选接口：" + result);
						var data = JSON.parse(result);

						if(data.success == true) {
							mui.alert(data.message, '提示', function() {
								mui.back();
							});
						} else {
							mui.alert(data.message);
						}
					},
					error: function(xhr, type, errorThrown) {
						mui.alert(xhr.status);
						plus.nativeUI.closeWaiting();
						console.log("error:" + xhr.response);
						console.log("error:" + xhr.status);
					}
				});
			}

			function initAudioMy() {
				/**
				 * 录音列表，录音弹出框
				 */
				mui.fn.audioListInit = function(options) {
					var audioListAll = this;
					if(audioListAll.length > 0) {
						var audioDiv = document.createElement("div");
						audioDiv.className = "rprogress";
						audioDiv.innerHTML = '<div class="rschedule"><img src="images/audioLoading.gif" width="46px" height="46px" /></div>' +
							'<div class="r-sigh">!</div><div class="rsalert"></div>';
						mui("body")[0].appendChild(audioDiv);

						var recordCancel = false; //录音结束标志位
						var recorder = null; //录音对象
						var holdData = null; //按住的时间
						var releaseData = null; //放手的时间
						var stopTimer = null; //结束计时器
						var boxSoundAlert = mui(".rprogress")[0];
						var audioTips = mui(".rprogress .rsalert")[0];
						var setSoundAlertVisable = function(show) {
							if(show) {
								boxSoundAlert.style.display = 'block';
								boxSoundAlert.style.opacity = 1;
							} else {
								boxSoundAlert.style.opacity = 0;
								//fadeOut 完成再真正隐藏
								setTimeout(function() {
									boxSoundAlert.style.display = 'none';
								}, 200);
							}
						};

						//上滑取消事件绑定
						mui("body")[0].addEventListener('drag', function(event) {
							if(Math.abs(event.detail.deltaY) > 50) {
								if(!recordCancel) {
									recordCancel = true;
									if(!audioTips.classList.contains("cancel")) {
										audioTips.classList.add("cancel");
									}
									audioTips.innerHTML = "正在录音";
								}
							} else {
								if(recordCancel) {
									recordCancel = false;
									if(audioTips.classList.contains("cancel")) {
										audioTips.classList.remove("cancel");
									}
									audioTips.innerHTML = "正在录音";
								}
							}
						}, false);

						//点击播放录音
						function playSound(soundBtn) {
							var iconDiv = soundBtn.querySelector(".audio");
							var soundPath = soundBtn.getAttribute("soundPath");
							if(iconDiv.className.match(new RegExp('(\\s|^)playing(\\s|$)'))) {
								removeClass(iconDiv, "playing");
								player.stop();
							} else {
								if(soundPath) {
									var playingBtn = document.querySelector(".playing");
									if(playingBtn) {
										removeClass(playingBtn, "playing");
										player.stop();
									}
									player = plus.audio.createPlayer(soundPath);
									iconDiv.className += "playing";
									player.play(function() {
										removeClass(iconDiv, "playing");
									}, function(e) {});
								}
							}
						}

						audioListAll.each(function(e) {
							var audioList = this;
							audioList.className = "custom-media-list custom-audio-list";
							audioList.options = mui.extend(mui.AudioListOptionsDefaults, options);
							var addButtonHtml = '<button class="mui-icon mui-icon-mic media-item button-item"><h6>录音</h6></button>'
							audioList.innerHTML = addButtonHtml;
							audioList.addButton = audioList.querySelector(".button-item");
							if(null != audioPath && undefined != audioPath && "" != audioPath) {
								addSound(audioPath, soundTime, true);
							}
							//添加录音到回复区域--begin
							audioList.addButton.addEventListener("hold", function() {
								var nowAudioLength = audioList.querySelectorAll(".audio-item .audio").length; //已经有的录音条数
								if(!checkAudioNum(nowAudioLength)) {
									return;
								}
								recordCancel = false;
								if(stopTimer) clearTimeout(stopTimer);
								audioTips.innerHTML = "正在录音";
								boxSoundAlert.classList.remove('rprogress-sigh');
								setSoundAlertVisable(true);
								recorder = plus.audio.getRecorder();
								if(null == recorder) {
									plus.nativeUI.toast("不能获取录音对象");
									return;
								}
								holdData = new Date();
								recorder.record({
									filename: "_downloads/"
								}, function(path) {
									if(recordCancel) return;
									addSound(path, Math.round((releaseData - holdData) / 1000), false);
								}, function(e) {
									plus.nativeUI.toast("录音时出现异常: " + e.message);
								});
							}, false);

							audioList.addButton.addEventListener('release', function(event) {
								if(audioTips.classList.contains("cancel")) {
									audioTips.classList.remove("cancel");
									audioTips.innerHTML = "正在录音";
								}
								releaseData = new Date();
								if(releaseData - holdData < 1000) {
									audioTips.innerHTML = "录音时间太短";
									boxSoundAlert.classList.add('rprogress-sigh');
									recordCancel = true;
									stopTimer = setTimeout(function() {
										setSoundAlertVisable(false);
									}, 800);
								} else {
									setSoundAlertVisable(false);
								}
								recorder.stop();
							}, false);
							audioList.addButton.addEventListener("touchstart", function(e) {
								e.preventDefault();
							});

							function checkAudioNum(nowAudioLength) {
								var size = audioList.options.size;
								if(nowAudioLength >= 1) {
									mui.toast("只能录一条语音");
									return false;
								} else {
									return true;
								}
							}

							function addSound(path, duration, isFrist) {
								console.log("添加到列表的录音路径:" + path);
								var soundBtn = document.createElement("button");
								soundBtn.className = "media-item audio-item mui-row"
								if(isFrist) {
									soundBtn.setAttribute("soundPath", audioPath);
									soundBtn.setAttribute("duration", soundTime);
									soundBtn.setAttribute("addTime", (new Date()).getTime());
								} else {
									audioPath = path;
									soundTime = duration;
									soundBtn.setAttribute("soundPath", path);
									soundBtn.setAttribute("duration", duration);
									soundBtn.setAttribute("addTime", (new Date()).getTime());
								}

								soundBtn.innerHTML = '<div class="audio mui-col-"><span></span><span></span><span></span></div>' +
									'<div class="time mui-col-">' + duration + 's</div>' +
									'<span class="mui-icon mui-icon-closeempty"></span>'
								soundBtn.addEventListener('tap', function() {
									//playSound(this);
								});

								audioList.appendChild(soundBtn);
							}
						})

						audioListAll.on("click", ".media-item.audio-item", function(e) {
							var $this = this;
							if(e.target.className.match(new RegExp('(\\s|^)mui-icon-closeempty(\\s|$)'))) {
								var $parentNode = $this.parentNode;
								var btnArray = ['是', '否'];
								mui.confirm('确定删除？', '删除', btnArray, function(e2) {
									if(e2.index == 0) {

										audioPath = "";
										$parentNode.removeChild($this);
									}
								})
							} else {
								playSound($this);
							}
						})
					}

				}

				if(plus.networkinfo.getCurrentType() == plus.networkinfo.CONNECTION_NONE) {
					network = false;
				}
			}
		})(mui);
	</script>

</html>